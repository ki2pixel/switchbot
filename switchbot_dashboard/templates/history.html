<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historique Monitoring - SwitchBot Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/history.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sticky-footer.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3KnG48sFoc5yK5NkZYkrwUO6LJ8UWQ7NkTLsrK2MmHU7Nj3mmLlVr2j7fzG2bZj2rFJqxRwW5+KQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      /* Centrage des checkboxes de métriques */
      .metric-checkboxes {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }
      
      .metric-checkboxes .form-check {
        display: flex;
        align-items: center;
        margin: 0;
      }
      
      .metric-checkboxes .form-check-input {
        margin-right: 0.5rem;
      }
      
      @media (max-width: 768px) {
        .metric-checkboxes {
          flex-direction: column;
          gap: 0.5rem;
        }
      }
    </style>
  </head>
  <body class="sb-dark">
    <div class="container py-4">
      <header class="page-header mb-4">
        <div class="page-header-main">
          <h1 class="h3 mb-0">Historique Monitoring</h1>
          <p class="page-subtitle text-muted mb-0">
            Visualisez les tendances et analysez les données historiques.
          </p>
        </div>
      </header>

      <!-- Filters Section -->
      <section class="history-filters mb-4">
        <div class="card sb-card">
          <div class="card-body">
            <form id="filtersForm" class="row g-3 align-items-end">
              <div class="col-md-3">
                <label for="timeRange" class="form-label">Période</label>
                <select class="form-select sb-select" id="timeRange" name="timeRange">
                  <option value="1h">Dernière heure</option>
                  <option value="6h" selected>Dernières 6 heures</option>
                  <option value="24h">Dernières 24 heures</option>
                  <option value="custom">Personnalisé</option>
                </select>
              </div>
              <div class="col-md-3" id="customStartGroup" style="display: none;">
                <label for="customStart" class="form-label">Début</label>
                <input type="datetime-local" class="form-control sb-input" id="customStart" name="customStart">
              </div>
              <div class="col-md-3" id="customEndGroup" style="display: none;">
                <label for="customEnd" class="form-label">Fin</label>
                <input type="datetime-local" class="form-control sb-input" id="customEnd" name="customEnd">
              </div>
              <div class="col-md-2">
                <label for="granularity" class="form-label">Granularité</label>
                <select class="form-select sb-select" id="granularity" name="granularity">
                  <option value="minute">Par minute</option>
                  <option value="5min">Par 5 minutes</option>
                  <option value="15min">Par 15 minutes</option>
                  <option value="hour">Par heure</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Métriques</label>
                <div class="metric-checkboxes d-flex flex-wrap gap-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricTemp" value="temperature" checked>
                    <label class="form-check-label d-flex align-items-center" for="metricTemp">
                      <span>Température</span>
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricHumidity" value="humidity" checked>
                    <label class="form-check-label d-flex align-items-center" for="metricHumidity">
                      <span>Humidité</span>
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="metricAircon" value="assumed_aircon_power" checked>
                    <label class="form-check-label d-flex align-items-center" for="metricAircon">
                      <span>Climatisation</span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100" data-loader>
                  Appliquer
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Status Cards -->
      <section class="status-cards mb-4">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card sb-card status-card">
              <div class="card-body text-center">
                <div class="status-card__value" id="avgTemp">--</div>
                <div class="status-card__label">Température moyenne</div>
                <div class="status-card__unit">°C</div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card sb-card status-card">
              <div class="card-body text-center">
                <div class="status-card__value" id="avgHumidity">--</div>
                <div class="status-card__label">Humidité moyenne</div>
                <div class="status-card__unit">%</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Charts Section -->
      <section class="charts-section mb-4">
        <div class="row g-4">
          <!-- Temperature & Humidity Chart -->
          <div class="col-12">
            <div class="card sb-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Température & Humidité</h5>
                <div class="chart-controls">
                  <button class="btn btn-sm btn-outline-secondary" id="resetZoomTemp">
                    Réinitialiser zoom
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <canvas id="tempHumidityChart"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Aircon State Chart -->
          <div class="col-12">
            <div class="card sb-card">
              <div class="card-header">
                <h5 class="card-title mb-0">État Climatisation</h5>
              </div>
              <div class="card-body">
                <div class="chart-container" style="max-height: 300px;">
                  <canvas id="airconStateChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Latest Records Table -->
      <section class="latest-records mb-4">
        <div class="card sb-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Derniers enregistrements</h5>
            <button class="btn btn-sm btn-outline-secondary" id="refreshLatest">
              Actualiser
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-dark table-hover" id="latestTable">
                <thead>
                  <tr>
                    <th>Timestamp</th>
                    <th>Température</th>
                    <th>Humidité</th>
                    <th>Climatisation</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="latestTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                      Chargement...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Real-time Status -->
      <section class="real-time-status">
        <div class="card sb-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <small class="text-muted">Dernière mise à jour</small>
                <div class="fw-bold" id="lastUpdate">--</div>
              </div>
              <div class="d-flex align-items-center">
                <div class="status-indicator me-2" id="statusIndicator"></div>
                <span id="statusText">En attente</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    {% include '_footer_nav.html' %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/loaders.js') }}"></script>
    <script src="{{ url_for('static', filename='js/history.js') }}"></script>
  </body>
</html>
