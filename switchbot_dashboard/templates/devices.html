<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Devices - SwitchBot Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/devices.css') }}" />
  </head>
  <body class="sb-dark">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">Devices</h1>
        <a class="btn btn-outline-secondary" href="{{ url_for('dashboard.index') }}">Back</a>
      </div>

      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      {% if data %}
        {% set body = data.get("body", {}) or {} %}
        {% set device_list = body.get("deviceList") or [] %}
        {% set remote_list = body.get("infraredRemoteList") or [] %}

        <div class="card highlight-card mb-4" aria-live="polite">
          <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Inventory snapshot</p>
              <h2 class="h4 mb-0">{{ device_list | length }} physical · {{ remote_list | length }} infrared</h2>
            </div>
            <div class="ms-lg-auto">
              <p class="mb-0 text-muted">
                Utilise ces listes pour retrouver rapidement <code>meter_device_id</code> et <code>aircon_device_id</code>
                avant de mettre à jour <strong>config/settings.json</strong> (cf. docs/README.md).
              </p>
            </div>
          </div>
        </div>

        <section aria-labelledby="devices-heading" class="mb-5">
          <div class="section-title">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Physical devices</p>
              <h2 id="devices-heading" class="h4 mb-0">deviceList</h2>
            </div>
            {% if device_list %}
              <span class="badge rounded-pill bg-glass">{{ device_list | length }} found</span>
            {% endif %}
          </div>

          {% if device_list %}
            <div class="device-grid">
              {% for device in device_list %}
                <article class="device-card" aria-label="{{ device.get('deviceName') or 'SwitchBot device' }}">
                  <div class="device-card__header">
                    <div>
                      <h3 class="device-name">{{ device.get("deviceName") or "Unnamed device" }}</h3>
                      <p class="device-type text-muted mb-0">{{ device.get("deviceType") or "Unknown type" }}</p>
                    </div>
                    <span class="badge rounded-pill bg-accent">
                      {{ "Hub" if device.get("hubDeviceId") else "Standalone" }}
                    </span>
                  </div>

                  <dl class="device-meta">
                    <div>
                      <dt>ID</dt>
                      <dd class="device-id">{{ device.get("deviceId") or "—" }}</dd>
                    </div>
                    <div>
                      <dt>Hub</dt>
                      <dd>{{ device.get("hubDeviceId") or "None" }}</dd>
                    </div>
                    <div>
                      <dt>Firmware</dt>
                      <dd>{{ device.get("firmwareVersion") or "Unknown" }}</dd>
                    </div>
                    <div>
                      <dt>Cloud</dt>
                      <dd>{{ "Enabled" if device.get("enableCloudService") else "Disabled" }}</dd>
                    </div>
                    <div>
                      <dt>Status</dt>
                      <dd class="{{ 'text-success' if device.get('status') == 'online' else 'text-warning' }}">
                        {{ device.get("status") or "n/a" }}
                      </dd>
                    </div>
                    <div>
                      <dt>Battery</dt>
                      <dd>{{ device.get("battery") or "—" }}</dd>
                    </div>
                  </dl>

                  <div class="device-actions">
                    <button
                      type="button"
                      class="btn btn-copy"
                      data-copy="{{ device.get('deviceId') }}"
                      aria-label="Copier l'identifiant {{ device.get('deviceName') }}"
                    >
                      Copier l'ID
                    </button>
                    {% if device.get("virtualModel") %}
                      <span class="badge rounded-pill bg-outline">{{ device.get("virtualModel") }}</span>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">Aucun device physique n'a été renvoyé.</p>
          {% endif %}

          <!-- Collapsible raw JSON retained for troubleshooting without overwhelming the main UI -->
          <details class="raw-block mt-3">
            <summary>Afficher le JSON brut deviceList</summary>
            <pre>{{ device_list | tojson(indent=2) }}</pre>
          </details>
        </section>

        <section aria-labelledby="remotes-heading">
          <div class="section-title">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Infrared remotes</p>
              <h2 id="remotes-heading" class="h4 mb-0">infraredRemoteList</h2>
            </div>
            {% if remote_list %}
              <span class="badge rounded-pill bg-glass">{{ remote_list | length }} found</span>
            {% endif %}
          </div>

          {% if remote_list %}
            <div class="device-grid">
              {% for remote in remote_list %}
                <article class="device-card" aria-label="{{ remote.get('remoteName') or 'Infrared remote' }}">
                  <div class="device-card__header">
                    <div>
                      <h3 class="device-name">{{ remote.get("remoteName") or "Unnamed remote" }}</h3>
                      <p class="device-type text-muted mb-0">{{ remote.get("remoteType") or "Unknown type" }}</p>
                    </div>
                    <span class="badge rounded-pill bg-accent">
                      {{ remote.get("hubDeviceId") or "Hub n/a" }}
                    </span>
                  </div>

                  <dl class="device-meta">
                    <div>
                      <dt>ID</dt>
                      <dd class="device-id">{{ remote.get("deviceId") or "—" }}</dd>
                    </div>
                    <div>
                      <dt>Brand</dt>
                      <dd>{{ remote.get("remoteBrand") or "Unknown" }}</dd>
                    </div>
                    <div>
                      <dt>Model</dt>
                      <dd>{{ remote.get("remoteModel") or "Unknown" }}</dd>
                    </div>
                    <div>
                      <dt>Category</dt>
                      <dd>{{ remote.get("remoteDeviceType") or "n/a" }}</dd>
                    </div>
                    <div>
                      <dt>Cloud</dt>
                      <dd>{{ "Enabled" if remote.get("enableCloudService") else "Disabled" }}</dd>
                    </div>
                  </dl>

                  <div class="device-actions">
                    <button
                      type="button"
                      class="btn btn-copy"
                      data-copy="{{ remote.get('deviceId') }}"
                      aria-label="Copier l'identifiant {{ remote.get('remoteName') }}"
                    >
                      Copier l'ID
                    </button>
                    {% if remote.get("hubDeviceId") %}
                      <span class="badge rounded-pill bg-outline">Hub {{ remote.get("hubDeviceId") }}</span>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">Aucune télécommande IR n'a été renvoyée.</p>
          {% endif %}

          <details class="raw-block mt-3">
            <summary>Afficher le JSON brut infraredRemoteList</summary>
            <pre>{{ remote_list | tojson(indent=2) }}</pre>
          </details>
        </section>
      {% else %}
        <div class="alert alert-warning">No data.</div>
      {% endif %}
    </div>
    <script>
      document.addEventListener("click", async (event) => {
        if (!event.target.matches(".btn-copy")) {
          return;
        }

        const button = event.target;
        const value = button.getAttribute("data-copy");
        if (!value) {
          return;
        }

        try {
          await navigator.clipboard.writeText(value);
          const original = button.textContent;
          button.textContent = "Copié ✓";
          button.setAttribute("aria-live", "assertive");
          setTimeout(() => {
            button.textContent = original;
            button.removeAttribute("aria-live");
          }, 1800);
        } catch (err) {
          console.error("Clipboard copy failed", err);
        }
      });
    </script>
  </body>
</html>
