<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Appareils - SwitchBot Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/devices.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sticky-footer.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  </head>
  <body class="sb-dark">
    <div class="container py-4">
      <h1 class="h3 mb-4">Appareils</h1>

      {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      {% if data %}
        {% set body = data.get("body", {}) or {} %}
        {% set device_list = body.get("deviceList") or [] %}
        {% set remote_list = body.get("infraredRemoteList") or [] %}

        <div class="card highlight-card mb-4" aria-live="polite">
          <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center gap-3">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Instantané d'inventaire</p>
              <h2 class="h4 mb-0">{{ device_list | length }} physiques · {{ remote_list | length }} infrarouges</h2>
            </div>
            <div class="ms-lg-auto">
              <p class="mb-0 text-muted">
                Utilise ces listes pour retrouver rapidement <code>meter_device_id</code> et <code>aircon_device_id</code>
                avant de mettre à jour <strong>config/settings.json</strong> (cf. docs/README.md).
              </p>
            </div>
          </div>
        </div>

        <section aria-labelledby="devices-heading" class="mb-5">
          <div class="section-title">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Appareils physiques</p>
              <h2 id="devices-heading" class="h4 mb-0">Liste des appareils</h2>
            </div>
            {% if device_list %}
              <span class="badge rounded-pill bg-glass">{{ device_list | length }} trouvés</span>
            {% endif %}
          </div>

          {% if device_list %}
            <div class="device-grid">
              {% for device in device_list %}
                <article class="device-card" aria-label="{{ device.get('deviceName') or 'Appareil SwitchBot' }}">
                  <div class="device-card__header">
                    <div>
                      <h3 class="device-name">{{ device.get("deviceName") or "Appareil sans nom" }}</h3>
                      <p class="device-type text-muted mb-0">{{ device.get("deviceType") or "Type inconnu" }}</p>
                    </div>
                    <span class="badge rounded-pill bg-accent">
                      {{ "Hub" if device.get("hubDeviceId") else "Autonome" }}
                    </span>
                  </div>

                  <dl class="device-meta device-meta--primary">
                    <div>
                      <dt>ID</dt>
                      <dd class="device-id">{{ device.get("deviceId") or "—" }}</dd>
                    </div>
                    <div>
                      <dt>Statut</dt>
                      <dd class="{{ 'text-success' if device.get('status') == 'online' else 'text-warning' }}">
                        {{ device.get("status") or "n/d" }}
                      </dd>
                    </div>
                  </dl>

                  <details class="device-details">
                    <summary>Voir les détails</summary>
                    <dl class="device-meta device-meta--secondary">
                      <div>
                        <dt>Hub</dt>
                        <dd>{{ device.get("hubDeviceId") or "Aucun" }}</dd>
                      </div>
                      <div>
                        <dt>Firmware</dt>
                        <dd>{{ device.get("firmwareVersion") or "Inconnu" }}</dd>
                      </div>
                      <div>
                        <dt>Cloud</dt>
                        <dd>{{ "Activé" if device.get("enableCloudService") else "Désactivé" }}</dd>
                      </div>
                      <div>
                        <dt>Batterie</dt>
                        <dd>{{ device.get("battery") or "—" }}</dd>
                      </div>
                    </dl>
                  </details>

                  <div class="device-actions">
                    <button
                      type="button"
                      class="btn btn-copy"
                      data-copy="{{ device.get('deviceId') }}"
                      aria-label="Copier l'identifiant {{ device.get('deviceName') }}"
                    >
                      Copier l'ID
                    </button>
                    {% if device.get("virtualModel") %}
                      <span class="badge rounded-pill bg-outline">{{ device.get("virtualModel") }}</span>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">Aucun appareil physique n'a été renvoyé.</p>
          {% endif %}

          <!-- Collapsible raw JSON retained for troubleshooting without overwhelming the main UI -->
          <details class="raw-block mt-3">
            <summary>Afficher le JSON brut deviceList</summary>
            <pre>{{ device_list | tojson(indent=2) }}</pre>
          </details>
        </section>

        <section aria-labelledby="remotes-heading">
          <div class="section-title">
            <div>
              <p class="text-uppercase small text-muted fw-semibold mb-1">Télécommandes infrarouges</p>
              <h2 id="remotes-heading" class="h4 mb-0">Liste des télécommandes</h2>
            </div>
            {% if remote_list %}
              <span class="badge rounded-pill bg-glass">{{ remote_list | length }} trouvées</span>
            {% endif %}
          </div>

          {% if remote_list %}
            <div class="device-grid">
              {% for remote in remote_list %}
                <article class="device-card" aria-label="{{ remote.get('remoteName') or 'Télécommande infrarouge' }}">
                  <div class="device-card__header">
                    <div>
                      <h3 class="device-name">{{ remote.get("remoteName") or "Télécommande sans nom" }}</h3>
                      <p class="device-type text-muted mb-0">{{ remote.get("remoteType") or "Type inconnu" }}</p>
                    </div>
                    <span class="badge rounded-pill bg-accent">
                      {{ remote.get("hubDeviceId") or "Hub n/d" }}
                    </span>
                  </div>

                  <dl class="device-meta device-meta--primary">
                    <div>
                      <dt>ID</dt>
                      <dd class="device-id">{{ remote.get("deviceId") or "—" }}</dd>
                    </div>
                    <div>
                      <dt>Marque</dt>
                      <dd>{{ remote.get("remoteBrand") or "Inconnue" }}</dd>
                    </div>
                  </dl>

                  <details class="device-details">
                    <summary>Voir les détails</summary>
                    <dl class="device-meta device-meta--secondary">
                      <div>
                        <dt>Modèle</dt>
                        <dd>{{ remote.get("remoteModel") or "Inconnu" }}</dd>
                      </div>
                      <div>
                        <dt>Catégorie</dt>
                        <dd>{{ remote.get("remoteDeviceType") or "n/d" }}</dd>
                      </div>
                      <div>
                        <dt>Cloud</dt>
                        <dd>{{ "Activé" if remote.get("enableCloudService") else "Désactivé" }}</dd>
                      </div>
                    </dl>
                  </details>

                  <div class="device-actions">
                    <button
                      type="button"
                      class="btn btn-copy"
                      data-copy="{{ remote.get('deviceId') }}"
                      aria-label="Copier l'identifiant {{ remote.get('remoteName') }}"
                    >
                      Copier l'ID
                    </button>
                    {% if remote.get("hubDeviceId") %}
                      <span class="badge rounded-pill bg-outline">Hub {{ remote.get("hubDeviceId") }}</span>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted fst-italic">Aucune télécommande IR n'a été renvoyée.</p>
          {% endif %}

          <details class="raw-block mt-3">
            <summary>Afficher le JSON brut infraredRemoteList</summary>
            <pre>{{ remote_list | tojson(indent=2) }}</pre>
          </details>
        </section>
      {% else %}
        <div class="alert alert-warning">Aucune donnée.</div>
      {% endif %}
    </div>
    
    {% include '_footer_nav.html' %}
    
    <script src="{{ url_for('static', filename='js/devices.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loaders.js') }}"></script>
  </body>
</html>
