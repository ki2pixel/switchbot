<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quota API SwitchBot</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sticky-footer.css') }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  </head>
  <body class="sb-dark">
    <div class="container py-4">
      <header class="page-header mb-4">
        <div class="page-header-main">
          <h1 class="h3 mb-0">Quota API quotidien</h1>
          <p class="page-subtitle text-muted mb-0">
            Surveillez votre consommation SwitchBot et anticipez les coupures.
          </p>
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-3" aria-live="polite" aria-atomic="true">
            {% for category, message in messages %}
              {% if category == 'error' %}
                <div class="alert alert-danger" role="alert" data-auto-dismiss="6000">
                  {{ message }}
                </div>
              {% elif category == 'success' %}
                <div class="alert alert-success" role="alert" data-auto-dismiss="6000">
                  {{ message }}
                </div>
              {% else %}
                <div class="alert alert-info" role="alert" data-auto-dismiss="6000">
                  {{ message }}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <article class="card">
        <div class="card-body">
          <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-4">
            <div class="api-quota flex-grow-1">
              <span class="api-quota-label">Suivi journalier</span>
              {% if api_quota_day %}
                <div class="api-quota-meta">
                  Jour suivi : <strong>{{ api_quota_day }}</strong>
                  {% if api_quota_reset_at %}
                    <span class="separator">•</span>
                    Reset prévu : <strong>{{ api_quota_reset_at }}</strong>
                  {% else %}
                    <span class="separator">•</span>
                    Reset automatique à 00:00 UTC
                  {% endif %}
                </div>
              {% endif %}

              <div class="api-quota-values">
                <div class="api-quota-metric">
                  <span class="metric-label">Restantes</span>
                  <span class="metric-value">
                    {{ api_requests_remaining if api_requests_remaining is not none else "N/A" }}
                  </span>
                </div>
                <span class="api-quota-separator" aria-hidden="true"></span>
                <div class="api-quota-metric">
                  <span class="metric-label">Utilisées</span>
                  <span class="metric-value">
                    {{ api_requests_total if api_requests_total is not none else "N/A" }}
                  </span>
                  <span class="metric-cap">
                    / {{ api_requests_limit if api_requests_limit is not none else "10,000" }}
                  </span>
                </div>
              </div>

              {% if show_quota_warning %}
                <div class="quota-alert alert alert-warning mt-3" role="status">
                  <strong>Attention : quota critique.</strong>
                  <span>
                    Il ne reste que {{ api_requests_remaining }} appels (seuil fixé à {{ quota_warning_threshold }}).
                  </span>
                </div>
              {% endif %}
            </div>

            <div class="text-muted small flex-grow-1">
              <p class="mb-2">
                Le compteur s'appuie sur <strong>ApiQuotaTracker</strong> :
              </p>
              <ul class="mb-3 ps-4">
                <li>Réinitialisation automatique à minuit (UTC)</li>
                <li>Fallback local si les en-têtes SwitchBot sont absents</li>
                <li>Inclut les appels manuels, scènes et boucles d'automatisation</li>
              </ul>
              <p class="mb-0">
                Ajustez le seuil d'alerte dans les réglages de l'accueil pour être prévenu suffisamment tôt.
              </p>
            </div>
          </div>
        </div>
      </article>
    </div>
    
    {% include '_footer_nav.html' %}
    
    <script src="{{ url_for('static', filename='js/alerts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loaders.js') }}"></script>
  </body>
</html>
