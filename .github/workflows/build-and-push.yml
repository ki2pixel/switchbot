name: Build and Push SwitchBot Dashboard

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ki2pixel/switchbot

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Trigger Render deployment (webhook + API fallback)
        env:
          WEBHOOK_URL: ${{ secrets.RENDER_DEPLOY_WEBHOOK_URL }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          IMAGE_TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        run: |
          set -euo pipefail

          if [ -z "${WEBHOOK_URL}" ]; then
            echo "WEBHOOK_URL is required."
            exit 1
          fi

          if [ -z "${RENDER_API_KEY}" ] || [ -z "${RENDER_SERVICE_ID}" ]; then
            echo "Render API fallback requires RENDER_API_KEY and RENDER_SERVICE_ID."
            exit 1
          fi

          payload=$(jq -n \
            --arg sha "${GITHUB_SHA}" \
            --arg image "${IMAGE_TAG}" \
            '{source:"github-actions", sha:$sha, image:$image}')

          echo "Triggering Render webhook..."
          http_code=$(curl -sS -o /tmp/webhook-response.txt -w "%{http_code}" \
            -X POST "${WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d "${payload}")

          cat /tmp/webhook-response.txt || true
          if [ "${http_code}" -ge 200 ] && [ "${http_code}" -lt 300 ]; then
            echo "Webhook accepted by Render (status ${http_code})."
            exit 0
          fi

          echo "Webhook failed with status ${http_code}. Falling back to Render API..."
          api_response=$(curl -sS -o /tmp/render-response.txt -w "%{http_code}" \
            -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "${payload}")

          cat /tmp/render-response.txt || true
          if [ "${api_response}" -ge 200 ] && [ "${api_response}" -lt 300 ]; then
            echo "Render API deploy triggered successfully (status ${api_response})."
            exit 0
          fi

          echo "Render API deploy failed with status ${api_response}."
          exit 1
